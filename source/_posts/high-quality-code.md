title: 编写高质量代码的思考
date: 2017-08-09 23:56:52
tags:
categories: 编程实践
---

## 前言
最近在看《代码大全》，可以说是一本软件开发的百科全书，特别厚，但是干货也很多。平时写代码，代码规范是一个最低的要求（很多老代码连最低要求都达不到），为什么要这样规定代码要这么写，而不是那么写？这是一个值得深究的问题。而不是说我照着代码规范写代码就算完了，高质量的代码是一个专业工程师的追求。要知其然知其所以然，最近写发票解析的代码，因为涉及带解析PDF的算法，复杂度比较高，所以花了很多时间在重构，学以致用的时候积累了一些心得。
## 信息隐藏原则
信息隐藏是面向对象设计的一个原则，是对封装和模块化的一个更高维度的概括。从Java的整个访问限制设计就体现了信息隐藏的原则，各种访问修饰符：`public,protect,private`，在类设计的时候，我们就要决定什么暴露给外部，什么隐藏起来。

举一个例子下面的代码表示一个有自增ID的`Person`类。
```
public class Person {
    int id;
    private static int G_MAX_ID = 0;
    public Person() {
      this.id = ++G_MAX_ID;
    }
}
```
上面的类设计有什么问题呢？它违反了信息隐藏的原则，直接将ID分配的方式暴露了，这会给后面的维护带来很多问题：当你想给id的范围做出限制的时候怎么办？当你在所有代码中使用`++G_MAX_ID`分配ID时突然需要修改ID分配的算法怎么办？是不是需要去改所有`++G_MAX_ID`出现的地方？更好的设计是将ID的分配算法隐藏起来。
```
public class Person {
    int id;
    private static int G_MAX_ID = 0;
    public Person() {
      this.id = NewId();
    }
    private int NewId() {
      return ++G_MAX_ID;
    }
}
```
咋一看只是将`++G_MAX_ID`写到一个方法里面而已，但是它隐藏了ID分配的算法，让调用者不需要关心里面的实现，同时控制了变化，不管ID分配算法怎么变，都不会影响其他的代码。调用者了解的信息越多，受到的影响就越大，信息隐藏可以降低复杂度，控制变化的范围。

上面的例子只是信息隐藏的一个简单应用，下面我们来举几个其他的应用例子：

- 为什么不推荐使用魔法值（即未经定义的常量）？：这个明显违反了信息隐藏的原则，当你将字面量直接写在代码里面时，就将信息直接暴露了，后面需要修改的时候，一旦少改了某个地方的字面量，bug就出现了。
- 循环依赖（即A调用B，B调用A的情况）：类或方法之间的循环依赖会破坏信息隐藏，一个很直接的影响就是在测试的时候，A，B都需要同时准备好才能进行测试，而无法mock任意一方。
- 使用全局变量：这个就不用说了，所有人都可以访问你的时候信息就暴露无疑了，全局变量能不用就不用。
- 考虑性能损失：有时候我们为了一些性能上的考虑就破坏信息隐藏原则，将一些变量全局化，这样性能提高得不多，维护成本却上升不少，完全是得不偿失。

最后总结一下信息隐藏的好处：

- 隐藏信息即隐藏了复杂度，降低了编程的负担。
- 隐藏信息即隐藏了底层变化，以便于在局部控制变化。

## 一些不太常见的编程技巧
### 函数(function)与过程(procedure)的选择
我们先来看看函数与过程区别：

- Function：有返回值的方法
- Procedure：没有返回值的方法

平时我们编程其实没有太区别函数与过程，什么时候用函数，什么时候用过程其实没有过多的考虑，感觉都可以用。一个选择的规则就是**当你的方法的目的是想返回跟你方法名称相符的值的时候用函数，否则用过程**

举个例子，我看过很多`XXProcessor`接口里面的方法都是`XX process()`，严格来讲，这样的命名是不符合上面的规则的，`process`是一个没有含义的命名，但是却有返回值，如果没有返回值那它的命名才是合理的。

当然了，上面的规则仅供参考，世事无绝对，具体情况具体分析，当你不清楚用函数还是用过程的时候，可以参考这个规则。

### 使用boolean值来给程序做注释
相信大家看到一个if语句有很多条件的时候都会特别头痛，因为很难理解。例如下面的例子：
```
if ( ( elementIndex < 0 ) || ( MAX_ELEMENTS < elementIndex ) || elementIndex == lastElementIndex) {
  do....
}
```
但如果换成下面的写法，用boolean值的名字来给if语句注释，看起来就很好理解了。
```
finished = ( ( elementIndex < 0 ) || ( MAX_ELEMENTS < elementIndex ) );
repeatedEntry = ( elementIndex == lastElementIndex );
if ( finished || repeatedEntry ) {
...
}
```
## 总结
怎么写高质量的代码是一个很大的话题，这里只是抛砖引玉，其实面向对象设计的很多原则都能够给我们写代码的时候提供指导，写代码的时候要时刻记得学以致用，而不是敷衍了事，专业的软件工程师必然要能写得一手好代码。




